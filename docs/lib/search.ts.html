<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>./lib/search.ts annotated source</title>
    <link rel="stylesheet" href="/libsearch/main.css">
</head>

<body>
    <main>
        <div class="line">
            <div class="doc">
                <h1>./lib/search.ts <span class="fade">annotated source</span></h1>
                <em><a class="back" href="/libsearch/">Back to index</a></em>
            </div>
            <pre></pre>
        </div>
        <div class="line"><div class="doc"><h2 id="basic-principles">Basic principles</h2>
</div><pre class="source javascript"><strong class="lineNumber">2</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>TODO: Explain stuff...</p>
</div><pre class="source javascript"><strong class="lineNumber">4</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><h2 id="implementation">Implementation</h2>
</div><pre class="source javascript"><strong class="lineNumber">6</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>To turn every potential query into a regular expression, we need to be able
to escape key characters.</p>
</div><pre class="source javascript"><strong class="lineNumber">9</strong>function escapeForRegExp(text: string): string {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">10</strong>    return text.replace(/[.*+?^${}[\]()|\\]/g, '\\$1');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">11</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">12</strong></pre></div>
<div class="line"><div class="doc"><p>Utility function for sorting an array by some predicate, rather than a
comparator function.</p>
</div><pre class="source javascript"><strong class="lineNumber">15</strong>function sortBy&#60;T&#62;(items: T[], by: (_it: T) =&#62; any): T[] {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">16</strong>    return items.sort((a, b) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">17</strong>        const aby = by(a);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">18</strong>        const bby = by(b);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">19</strong>        if (aby &#60; bby) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">20</strong>            return 1;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">21</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">22</strong>        if (bby &#60; aby) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">23</strong>            return -1;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">24</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">25</strong>        return 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">26</strong>    });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">27</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">28</strong></pre></div>
<div class="line"><div class="doc"><p>The main search function takes:</p>
<ul>
<li><code>items</code>, the list of items to search</li>
<li><code>query</code>, the search query text</li>
<li><code>by</code>, which is a predicate (string, number, or function) that takes an item from the items list and returns the string that should be matched with the query</li>
</ul>
<p>Options include</p>
<ul>
<li><code>caseSensitive</code>, which is self-explanatory</li>
<li><code>mode</code>: which is &#39;word&#39; or &#39;prefix&#39; (&#39;prefix&#39; by default)</li>
</ul>
</div><pre class="source javascript"><strong class="lineNumber">37</strong>export function search&#60;T&#62;(items: T[], query: string, by: (_it: T) =&#62; any = x =&#62; x, {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">38</strong>    caseSensitive = false,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">39</strong>    mode = 'prefix',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">40</strong>}: {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">41</strong>    caseSensitive?: boolean;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">42</strong>    mode?: 'word' | 'prefix';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">43</strong>} = {}) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">44</strong>    function countMatches(s: string, regexp: RegExp): number {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">45</strong>        let i = 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">46</strong>        while (regexp.exec(s) !== null) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">47</strong>            i ++;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">48</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">49</strong>        return i;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">50</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">51</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">52</strong>    const words = query</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">53</strong>        .trim()</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">54</strong>        .split(' ')</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">55</strong>        .filter(s =&#62; s !== '');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">56</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">57</strong>    if (words.length === 0) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">58</strong>        return items;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">59</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">60</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">61</strong>    const tfidf = new Map&#60;T, number&#62;();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">62</strong>    const suggestions = words.reduce((suggestions, word, i) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">63</strong>        const isLastWord = i + 1 === words.length;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">64</strong>        const regexp = new RegExp(</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">65</strong>            '(^|\\W)' + escapeForRegExp(word) + (isLastWord || mode === 'prefix' ? '' : '($|\\W)'),</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">66</strong>            // the "u" flag for Unicode used to be used here, but was removed</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">67</strong>            // because it was (1) across-the-board too slow, and removing it</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">68</strong>            // made a statistically significant speed improvement, and (2)</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">69</strong>            // caused at least Chrome to have strange performance cliffs in</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">70</strong>            // unpredictable ways where certain regexp operations would take</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">71</strong>            // 10s of ms.</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">72</strong>            caseSensitive ? 'mg' : 'img'</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">73</strong>        );</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">74</strong>        return suggestions.filter(sugg =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">75</strong>            const text = by(sugg);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">76</strong>            const count = countMatches(text, regexp);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">77</strong>            if (count === 0) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">78</strong>                return false;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">79</strong>            }</pre></div>
<div class="line"><div class="doc"><p>TF-IDF weighting per-term</p>
</div><pre class="source javascript"><strong class="lineNumber">81</strong>            tfidf.set(</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">82</strong>                sugg,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">83</strong>                (tfidf.get(sugg) || 0)</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">84</strong>                    + (count / text.length * Math.log(items.length / suggestions.length))</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">85</strong>            );</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">86</strong>            return true;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">87</strong>        })</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">88</strong>    }, items);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">89</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">90</strong>    return sortBy(suggestions, sugg =&#62; tfidf.get(sugg));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">91</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">92</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">93</strong></pre></div>
    </main>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github-gist.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>
        for (const el of document.querySelectorAll('.line pre')) {
            hljs.highlightBlock(el);
        }
    </script>
</body>

</html>